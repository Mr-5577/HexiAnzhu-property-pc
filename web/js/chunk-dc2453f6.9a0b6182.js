(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-dc2453f6"],{"5b08":function(e,t,a){"use strict";a.r(t);var s=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{attrs:{id:"ic-manage"}},[t("div",{staticClass:"top"},[t("div",{staticClass:"main"},[t("div",{staticClass:"common-left"},[t("span",{staticClass:"common-chose-info",on:{click:function(t){return e.$refs.showFilterVillage.showDialog()}}},[t("i",{staticClass:"iconfont icondaqu"}),e._v(" "+e._s(e.choseVillageInfo.name)+" "),e.choseVillageInfo.vid?t("i",{staticClass:"close el-icon-circle-close",on:{click:function(t){return t.stopPropagation(),e.filterVillage({name:"全部项目",vid:""})}}}):e._e()]),t("el-select",{attrs:{clearable:"",placeholder:"请筛选状态"},on:{change:e.tableLoad},model:{value:e.statusVal,callback:function(t){e.statusVal=t},expression:"statusVal"}},e._l(e.statusOptions,(function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1),t("input",{directives:[{name:"model",rawName:"v-model",value:e.searchVal,expression:"searchVal"}],staticClass:"common-input",attrs:{type:"text",placeholder:"请输入卡号或姓名查询"},domProps:{value:e.searchVal},on:{input:function(t){t.target.composing||(e.searchVal=t.target.value)}}}),t("el-button",{staticClass:"common-button",attrs:{type:"primary",icon:"el-icon-search"},on:{click:function(t){return e.keySearch(!0)}}},[e._v(" 查询 ")])],1),t("div",{staticClass:"common-right"},[e.$menu.getters.judgeRole("Btn-1kV4hlRyThWvJBG6buzEGxNUGN")?t("el-button",{staticClass:"common-button",attrs:{type:"success",plain:"",icon:"iconfont icona-zu4462"},on:{click:e.bathCard}},[e._v(" 批量制卡 ")]):e._e(),e.$menu.getters.judgeRole("Btn-kjAY0H5JDaxjDzLXvDfaGxGw96")?t("el-button",{staticClass:"common-button",attrs:{type:"warning",plain:"",icon:"iconfont icona-zu4462"},on:{click:e.singleCard}},[e._v(" 单张制卡 ")]):e._e()],1)])]),t("div",{staticClass:"main-wp"},[t("div",{staticClass:"table-wp"},[t("cus-table",{attrs:{datas:e.tableData,cusColums:e.columns,cusConf:e.conf,ispaging:!0},on:{sizeChange:e.sizeChange,currentChange:e.currentChange,detail:e.cardDetail,card_again:e.cardAgain,icDelet:e.icDelet}})],1)]),t("el-dialog",{staticClass:"recycleDialog",attrs:{visible:e.showRecycleDialog,title:"回收IC卡",width:"30rem","close-on-click-modal":!1},on:{"update:visible":function(t){e.showRecycleDialog=t}}},[t("el-form",{ref:"ruleForm",attrs:{model:e.ruleForm,rules:e.rules,"hide-required-asterisk":!0}},[t("el-form-item",{attrs:{label:"IC卡名称",prop:"icId"}},[t("el-input",{attrs:{placeholder:"请输入IC卡名称"},model:{value:e.ruleForm.icId,callback:function(t){e.$set(e.ruleForm,"icId",t)},expression:"ruleForm.icId"}})],1),t("el-form-item",{attrs:{label:"IC卡卡号",prop:"icCode"}},[t("el-input",{attrs:{placeholder:"请将IC卡靠近刷卡位置读取"},model:{value:e.ruleForm.icCode,callback:function(t){e.$set(e.ruleForm,"icCode",t)},expression:"ruleForm.icCode"}})],1)],1),t("span",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{loading:e.isCommit,type:"primary",round:""},on:{click:e.formSubmit}},[e._v(" 确认回收 ")]),t("el-button",{attrs:{loading:e.isCommit,type:"info",round:""},on:{click:function(t){e.showRecycleDialog=!1}}},[e._v(" 取消 ")])],1)],1),t("el-dialog",{staticClass:"detailDialog",attrs:{visible:e.showDetailDialog,title:"IC卡详情",width:"40%","close-on-click-modal":!1},on:{"update:visible":function(t){e.showDetailDialog=t}}},[t("el-scrollbar",{staticStyle:{height:"100%"}},[t("div",{staticClass:"name"},[e._v("IC卡号："+e._s(e.detailData.code))]),t("div",{staticClass:"table-wp"},[t("div",{staticClass:"table-header"},[t("span",[e._v("道闸名称")]),t("span",[e._v("业主是否计费")]),t("span",[e._v("有效期")]),t("span",[e._v("状态标识")])]),t("ul",{staticClass:"table-body"},[e.detailData.iccardgate&&0!==e.detailData.iccardgate.length?e._e():t("li",{staticClass:"empty"},[t("span",[e._v("暂无数据")])]),e._l(e.detailData.iccardgate,(function(a,s){return t("li",{key:s},[t("span",[e._v(" "+e._s(a.gate&&a.gate.name?a.gate.name:"")+" ")]),t("span",{staticStyle:{color:"#999"}},[e._v(" "+e._s(a.gate?a.gate.is_free_text:"")+" ")]),t("span",[e._v(e._s(a.end_date))]),t("span",[e._v(e._s(a.card_gate_status_text))])])}))],2)])])],1),t("el-dialog",{staticClass:"batchDialog",attrs:{visible:e.showBatchDialog,title:"批量制卡",width:"40%","close-on-click-modal":!1},on:{"update:visible":function(t){e.showBatchDialog=t}}},[t("div",{staticClass:"select-wp"},[t("el-select",{attrs:{clearable:"",placeholder:"请选择项目"},on:{change:e.villChange},model:{value:e.villageVal,callback:function(t){e.villageVal=t},expression:"villageVal"}},e._l(e.villageOptions,(function(e){return t("el-option",{key:e.id,attrs:{label:e.villagename,value:e.id}})})),1),t("el-select",{attrs:{clearable:"",placeholder:"请选择楼栋"},on:{change:e.buildChange},model:{value:e.buildVal,callback:function(t){e.buildVal=t},expression:"buildVal"}},e._l(e.buildOptions,(function(e){return t("el-option",{key:e.id,attrs:{label:e.block,value:e.id}})})),1),t("el-select",{attrs:{clearable:"",placeholder:"请选择单元"},on:{change:e.unitChange},model:{value:e.unitVal,callback:function(t){e.unitVal=t},expression:"unitVal"}},e._l(e.unitOptions,(function(e){return t("el-option",{key:e.id,attrs:{label:e.unit,value:e.id}})})),1)],1),t("el-scrollbar",{directives:[{name:"loading",rawName:"v-loading",value:e.userLoading,expression:"userLoading"}],staticStyle:{height:"calc(100% - 3.75rem)"}},[e.userList&&0!==e.userList.length?t("ul",{staticClass:"user-wp"},e._l(e.userList,(function(a,s){return t("li",{key:s},[t("div",{staticClass:"name"},[e._v(" "+e._s(`${a.realname}-${a.type_name}(${a.roomnum})`)+" ")]),e._l(a.cards,(function(s,i){return t("div",{key:i,staticClass:"cards"},[t("el-input",{attrs:{placeholder:"请输入IC卡号"},model:{value:s.card,callback:function(t){e.$set(s,"card",t)},expression:"itm.card"}}),t("el-input",{attrs:{type:"number",placeholder:"请输入金额"},model:{value:s.money,callback:function(t){e.$set(s,"money",t)},expression:"itm.money"}}),i===a.cards.length-1?t("i",{staticClass:"el-icon-plus",on:{click:function(t){return e.addCard(a)}}}):t("i",{staticClass:"el-icon-close",on:{click:function(t){return e.delCard(a,i)}}})],1)})),e.userList&&e.userList.length>1?t("i",{staticClass:"userdel el-icon-close",on:{click:function(t){return e.delUser(s)}}}):e._e()],2)})),0):t("div",{staticClass:"empty"},[e._v(" 暂无数据！ ")])]),t("span",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{loading:e.isCommit,type:"primary",round:""},on:{click:e.makeCard}},[e._v(" 确认制卡 ")]),t("el-button",{attrs:{loading:e.isCommit,type:"info",round:""},on:{click:function(t){e.showBatchDialog=!1}}},[e._v(" 取消 ")])],1)],1),t("el-dialog",{staticClass:"singleDialog",attrs:{visible:e.showSingleDialog,title:"操作制卡",width:"36%","close-on-click-modal":!1},on:{"update:visible":function(t){e.showSingleDialog=t}}},[t("el-scrollbar",{staticStyle:{height:"100%"}},[t("el-autocomplete",{ref:"searchInput",staticClass:"user-search",attrs:{"popper-class":"my-autocomplete",debounce:0,"fetch-suggestions":e.querySearchAsync,placeholder:"请输入业主姓名/手机号或房号"},on:{select:e.handleSelect},scopedSlots:e._u([{key:"default",fn:function({item:a}){return[t("div",{staticClass:"tr-item"},[t("span",{staticClass:"td-item"},[e._v(e._s(a.realname))]),t("span",{staticClass:"td-item"},[e._v(" "+e._s(a.sex?a.sex:"未知")+" ")]),t("span",{staticClass:"td-item"},[e._v(e._s(a.tel))])]),e.allUserList.length>1&&a.id==e.allUserList[e.allUserList.length-1].id?t("div",{staticClass:"load-more",on:{click:function(t){return t.stopPropagation(),e.loadMore.apply(null,arguments)}}},[e._v(" "+e._s(e.nomore?"没有更多了":"点击加载更多")+" ")]):e._e(),e.allUserList.length<=1?t("div",{staticClass:"load-more",on:{click:function(t){return t.stopPropagation(),e.loadMore.apply(null,arguments)}}},[e._v(" 暂无数据！ ")]):e._e()]}}]),model:{value:e.autoValue,callback:function(t){e.autoValue=t},expression:"autoValue"}},[t("i",{staticClass:"iconfont iconzu3664 el-input__icon",attrs:{slot:"suffix"},slot:"suffix"})]),e.currentUser?t("ul",{staticClass:"user-wp"},[t("li",[t("div",{staticClass:"name"},[e._v(" "+e._s(e.currentUser.realname+"-"+(e.currentUser.owner_type&&e.currentUser.owner_type.name?e.currentUser.owner_type.name:"")+(e.currentUser&&e.currentUser.ownerRooms&&e.currentUser.ownerRooms.length>0?"("+e.currentUser.ownerRooms.map(e=>e.rooms.roomnum).join("、")+")":""))+" ")]),e._l(e.currentUser.cards,(function(a,s){return t("div",{key:s,staticClass:"cards"},[t("el-input",{attrs:{placeholder:"请输入IC卡号"},model:{value:a.card,callback:function(t){e.$set(a,"card",t)},expression:"itm.card"}}),t("el-input",{attrs:{type:"number",placeholder:"请输入金额"},model:{value:a.money,callback:function(t){e.$set(a,"money",t)},expression:"itm.money"}}),s===e.currentUser.cards.length-1?t("i",{staticClass:"el-icon-plus",on:{click:e.aloneAddCard}}):t("i",{staticClass:"el-icon-close",on:{click:function(t){return e.aloneDelCard(s)}}})],1)}))],2)]):e._e()],1),t("span",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{loading:e.isCommit,type:"primary",round:""},on:{click:e.aloneMakeCard}},[e._v(" 确认制卡 ")]),t("el-button",{attrs:{loading:e.isCommit,type:"info",round:""},on:{click:function(t){e.showBatchDialog=!1}}},[e._v(" 取消 ")])],1)],1),t("filter-village",{ref:"showFilterVillage",attrs:{vid:e.choseVillageInfo.vid},on:{choseInfo:e.filterVillage}})],1)},i=[],l=(a("5948"),a("a917")),o={name:"icmanage",data(){return{urlObj:{iclists:this.$api.state.Means.iclists.url,reclaim:this.$api.state.Means.reclaim.url,issueCar:this.$api.state.Means.issueCar.url,userSearch:this.$api.state.Means.userSearch.url,singlecard:this.$api.state.Means.singlecard.url,batchcard:this.$api.state.Means.batchcard.url,carddetail:this.$api.state.Means.carddetail.url,userVillage:this.$api.state.Public.userVillage.url,buildOfVillage:this.$api.state.Public.buildOfVillage.url,unitOfBuild:this.$api.state.Public.unitOfBuild.url,getOwners:this.$api.state.Public.getOwners.url,cardAgainUrl:this.$api.state.Means.cardAgain.url,card_delete:this.$api.state.Means.card_delete.url},choseVillageInfo:{name:"全部项目",vid:0},statusVal:"",statusOptions:[{value:-1,label:"未激活"},{value:1,label:"使用中"}],searchVal:"",tableData:[],columns:l.list,conf:{loadStatus:!1,emptyText:"",curPage:1,limit:20,dataTotal:0},tableSelected:[],showRecycleDialog:!1,ruleForm:{icCode:"",icId:""},rules:{icCode:[{required:!0,message:"请输入IC卡卡号",trigger:"blur"}],icId:[{required:!0,message:"请输入IC卡名称",trigger:"blur"}]},isCommit:!1,currentIndex:0,showDetailDialog:!1,detailData:{},showBatchDialog:!1,showSingleDialog:!1,villageVal:"",villageOptions:[],buildVal:"",buildOptions:[],unitVal:"",unitOptions:[],userList:[],autoValue:"",currentUser:{name:"张三",type:"业主",room:"1-1-01-01",cards:[{card:"",money:"20.00"}]},allUserList:[],nomore:!1,userLoading:!1}},mounted(){let e=sessionStorage.getItem("vid"),t=sessionStorage.getItem("vname");e&&(this.choseVillageInfo.vid=e,this.choseVillageInfo.name=t),this.tableLoad(),this.getUserVillage()},methods:{filterVillage(e){this.choseVillageInfo.name=e.name,this.choseVillageInfo.vid=e.vid,this.keySearch()},keySearch(){this.conf={loadStatus:!1,emptyText:"",curPage:1,limit:20,dataTotal:0},this.tableLoad()},tableLoad(){this.conf.loadStatus=!0;let e={vid:this.choseVillageInfo.vid,status:this.statusVal,keyword:this.searchVal,page:this.conf.curPage,limit:this.conf.limit};this.$axios.post(this.urlObj.iclists,e).then(e=>{200===e.Code?(e.Data.data&&e.Data.data.length>0&&e.Data.data.forEach(e=>{e.vname=e.village&&e.village.villagename?e.village.villagename:"--",e.ownername=e.carnonmotor&&e.carnonmotor.non_owner_name?e.carnonmotor.non_owner_name:e.owner?e.owner.realname:"--",e.ownertel=e.carnonmotor&&e.carnonmotor.non_owner_tel?e.carnonmotor.non_owner_tel:e.owner?e.owner.tel:"--"}),this.tableData=e.Data.data,this.conf.dataTotal=e.Data.total,this.conf.loadStatus=!1,this.conf.emptyText=""):204===e.Code?(this.$message({message:e.Message,type:"error"}),this.$router.push({path:this.$common.state.loginPath})):(this.tableData=[],this.conf.emptyText=e.Message,this.conf.dataTotal=0,this.conf.loadStatus=!1)}).catch(()=>{this.tableData=[],this.conf.emptyText="服务器连接失败...",this.conf.dataTotal=0,this.conf.loadStatus=!1})},sizeChange(e){this.conf.limit=e,this.tableLoad()},currentChange(e){this.conf.curPage=e,this.tableLoad()},selectionChange(e){this.tableSelected=e},recycleCard(){this.$refs.ruleForm&&this.$refs.ruleForm.resetFields(),this.showRecycleDialog=!0},formSubmit(){this.$refs.ruleForm.validate(e=>{if(e){this.isCommit=!0;let e={code:this.ruleForm.icCode,name:this.ruleForm.icId};this.$axios.post(this.urlObj.reclaim,e).then(e=>{if(200===e.Code)this.$message({type:"success",message:"IC卡回收成功！"}),this.showRecycleDialog=!1,this.tableLoad();else{let t=e.Message?e.Message:"IC卡回收失败！";this.$message({type:"error",message:t})}this.isCommit=!1}).catch(()=>{this.isCommit=!1})}})},cardDetail(e){this.showDetailDialog=!0,this.getCardDetail(this.tableData[e].id)},cardAgain(e){this.$confirm("确认重新下发此卡片?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{let t={id:this.tableData[e].id};this.$axios.post(this.urlObj.cardAgainUrl,t).then(e=>{if(200===e.Code)this.$message({type:"success",message:"下发成功"});else{let t=e.Message?e.Message:"重新下发失败！";this.$message({type:"error",message:t})}}).catch(()=>{})}).catch(()=>{})},icDelet(e){this.$confirm("确定要删除当前IC卡吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$axios.post(this.urlObj.card_delete,{id:this.tableData[e].id}).then(e=>{if(200===e.Code)this.$message({type:"success",message:"IC卡删除成功！"}),this.tableLoad();else{let t=e.Message?e.Message:"IC卡删除失败！";this.$message({type:"error",message:t})}}).catch(()=>{})}).catch(()=>{})},getCardDetail(e){this.$axios.post(this.urlObj.carddetail,{id:e}).then(e=>{if(200===e.Code)this.detailData=e.Data[0];else{let t=e.Message?e.Message:"IC卡详情数据获取失败！";this.$message({type:"error",message:t})}}).catch(()=>{})},getUserVillage(){this.$axios.post(this.urlObj.userVillage).then(e=>{if(200===e.Code)this.villageOptions=e.Data;else{let t=e.Message?e.Message:"获取项目数据失败!";this.$message({type:"error",message:t})}}).catch(()=>{this.$message({type:"error",message:"获取项目数据失败!"})})},getBuildData(){this.$axios.post(this.urlObj.buildOfVillage,{vid:this.villageVal}).then(e=>{if(200===e.Code)this.buildOptions=e.Data?e.Data:[];else{let t=e.Message?e.Message:"获取楼栋数据失败!";this.$message({type:"error",message:t})}}).catch(()=>{})},getUnitData(){this.$axios.post(this.urlObj.unitOfBuild,{bid:this.buildVal}).then(e=>{if(200===e.Code)this.unitOptions=e.Data?e.Data:[];else{let t=e.Message?e.Message:"获取单元数据失败!";this.$message({type:"error",message:t})}}).catch(()=>{})},getUserData(){this.userLoading=!0;let e={vid:this.villageVal,bid_ids:[this.buildVal]};this.unitVal&&(e.unit_ids=[this.unitVal]),this.$axios.post(this.urlObj.getOwners,e).then(e=>{if(200===e.Code)e.Data.forEach(e=>{e.cards=[{card:"",money:"20.00"}]}),this.userList=e.Data;else{let t=e.Message?e.Message:"获取业主数据失败!";this.$message({type:"error",message:t})}this.userLoading=!1}).catch(()=>{})},villChange(e){this.buildVal="",this.buildOptions=[],this.unitVal="",this.unitOptions=[],this.userList=[],e&&this.getBuildData()},buildChange(e){this.unitVal="",this.unitOptions=[],this.userList=[],e&&(this.getUnitData(),this.getUserData())},unitChange(e){this.userList=[],e&&this.getUserData()},bathCard(){this.villageVal=Number(this.choseVillageInfo.vid),this.buildVal="",this.buildOptions=[],this.unitVal="",this.unitOptions=[],this.userList=[],this.getBuildData(),this.showBatchDialog=!0},makeCard(){if(this.userList.length>0){let e=!0,t=[];if(this.userList.forEach(a=>{let s=[];a.cards.forEach(t=>{t.card&&t.money?s.push({code:t.card,money:t.money,oid:a.oid}):e=!1}),t.push(s)}),e){this.isCommit=!0;let e={vid:this.villageVal,cards:t};this.$axios.post(this.urlObj.batchcard,e).then(e=>{if(200===e.Code)this.$message({type:"success",message:"批量制卡成功！"}),this.showBatchDialog=!1,this.tableLoad();else{let t=e.Message?e.Message:"批量制卡失败!";this.$message({type:"error",message:t})}this.isCommit=!1}).catch(()=>{this.isCommit=!1})}else this.$message({type:"warning",message:"制卡信息不完整！"})}else this.$message({type:"warning",message:"请选择用户并填写制卡信息！"})},singleCard(){this.currentUser=null,this.showSingleDialog=!0},addCard(e){e.cards.unshift({card:"",money:"20.00"})},delCard(e,t){e.cards.splice(t,1)},delUser(e){this.userList.splice(e,1)},async querySearchAsync(e,t){let a={keywords:e,page:1,limit:20,vid:this.choseVillageInfo.vid},s=await this.$axios.post(this.urlObj.userSearch,a);if(200===s.Code){let e={id:0,realname:"姓名",sex:"性别",tel:"电话号码"};s.Data.data.unshift(e),this.allUserList=s.Data.data,this.nomore=!1,t(s.Data.data)}else this.$refs.searchInput.$children[0].blur()},async loadMore(){if(!this.nomore){let e={keywords:this.ruleForm.uname,page:Math.ceil(this.allUserList.length/20)+1,limit:20},t=await this.$axios.post(this.$api.state.Means.userSearch.url,e);200===t.Code&&(t.Data.data.length>0?(this.allUserList=this.allUserList.concat(t.Data.data),this.$refs.searchInput.suggestions=this.allUserList):this.nomore=!0)}},handleSelect(e){e.cards=[{card:"",money:"20.00"}],this.currentUser=JSON.parse(JSON.stringify(e))},aloneAddCard(){let e=JSON.parse(JSON.stringify(this.currentUser));e.cards.unshift({card:"",money:"20.00"}),this.currentUser=e},aloneDelCard(e){this.currentUser.cards.splice(e,1)},aloneMakeCard(){if(this.currentUser&&this.currentUser.cards.length>0){let e=this.currentUser.cards.every(e=>e.card&&e.money);if(e){this.isCommit=!0;let e={vid:this.choseVillageInfo.vid,oid:this.currentUser.id,cards:this.currentUser.cards.map(e=>({code:e.card,money:e.money}))};this.$axios.post(this.urlObj.singlecard,e).then(e=>{if(200===e.Code)this.$message({type:"success",message:"制卡成功！"}),this.showSingleDialog=!1,this.tableLoad();else{let t=e.Message?e.Message:"制卡失败!";this.$message({type:"error",message:t})}this.isCommit=!1}).catch(()=>{this.isCommit=!1})}else this.$message({type:"warning",message:"制卡信息不完整！"})}else this.$message({type:"warning",message:"请选择业主并填写制卡信息！"})}}},r=o,n=(a("e153"),a("1805")),c=Object(n["a"])(r,s,i,!1,null,null,null);t["default"]=c.exports},a917:function(e){e.exports=JSON.parse('{"commonet":{"label":"列名称","prop":"字段名称","width":"列宽度","type":"text/number/checkbox(0,1)/button","action":"抛出的方法名称","role":"type存在时使用操作加载对应的权限名","show":"显示/隐藏列","btns":{"name":"按钮名称","type":"按钮样式","size":"按钮大小","round":"是否圆角","class":"自定义class","action":"抛出的方法名称"}},"list":[{"label":"卡号","prop":"code","show":true},{"label":"项目","prop":"vname","show":true},{"label":"使用人","prop":"ownername","show":true,"color":"#999"},{"label":"联系电话","prop":"ownertel","show":true,"color":"#999"},{"label":"操作","prop":"","min-width":120,"type":"button","show":true,"btns":[{"name":"详情","token":"empty","type":"primary empty","size":"small","round":true,"action":"detail","role":"detail"},{"name":"重新下发","token":"Btn-ve0i2YC8WqqtxrmUTyVg2v5Mkq","type":"primary empty","size":"small","round":true,"action":"card_again","role":"card_again"},{"name":"删除","token":"empty","type":"danger empty","size":"small","round":true,"action":"icDelet","role":"icDelet"}]}]}')},bc0a:function(e,t,a){},e153:function(e,t,a){"use strict";a("bc0a")}}]);